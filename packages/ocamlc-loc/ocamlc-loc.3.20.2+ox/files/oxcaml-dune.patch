diff --git a/otherlibs/configurator/src/v1.ml b/otherlibs/configurator/src/v1.ml
index 1234567..abcdefg 100644
--- a/otherlibs/configurator/src/v1.ml
+++ b/otherlibs/configurator/src/v1.ml
@@ -134,12 +134,12 @@ module Process = struct
     let prog_command_line = command_line prog args in
     logf t "run: %s" prog_command_line;
     let n = gen_id t in
-    let create_process =
+    let create_process stdin stdout stderr =
       let args = Array.of_list (prog :: args) in
       match env with
-      | None -> Unix.create_process prog args
+      | None -> Unix.create_process prog args stdin stdout stderr
       | Some env ->
         let env = Array.of_list env in
-        Unix.create_process_env prog args env
+        Unix.create_process_env prog args env stdin stdout stderr
     in
     let stdout_fn = t.dest_dir ^/ sprintf "stdout-%d" n in
@@ -795,7 +795,7 @@ let main ?(args = []) ~name f =
     let t =
       create_from_inside_dune
         ~dest_dir:!dest_dir
-        ~log:(if !verbose then prerr_endline else log)
+        ~log:(if !verbose then fun s -> prerr_endline s else fun s -> log s)
         ~build_dir
         ~name
     in
diff --git a/otherlibs/stdune/src/fpath.ml b/otherlibs/stdune/src/fpath.ml
index 47bff89c0..e3f8e3d3c 100644
--- a/otherlibs/stdune/src/fpath.ml
+++ b/otherlibs/stdune/src/fpath.ml
@@ -128,7 +128,7 @@ let win32_unlink fn =
        retry_loop 30)
 ;;

-let unlink_exn = if Stdlib.Sys.win32 then win32_unlink else Unix.unlink
+let unlink_exn = if Stdlib.Sys.win32 then win32_unlink else fun s -> Unix.unlink s

 type unlink_status =
   | Success
diff --git a/otherlibs/stdune/src/queue.ml b/otherlibs/stdune/src/queue.ml
index 6a5fbb493..fb3db35a9 100644
--- a/otherlibs/stdune/src/queue.ml
+++ b/otherlibs/stdune/src/queue.ml
@@ -1,10 +1,16 @@
 include Stdlib.Queue

+let create () = create ()
 let push t x = add x t
 let peek_exn t = peek t
 let pop_exn t = pop t
 let pop t = if is_empty t then None else Some (pop_exn t)
 let peek t = if is_empty t then None else Some (peek t)
+let clear t = clear t
+let copy t = copy t
+let is_empty t = is_empty t
+let length t = length t
 let iter t ~f = iter f t
 let fold t ~f ~init = fold f init t
+let transfer t1 t2 = transfer t1 t2
 let to_list t = List.rev (fold t ~f:(fun acc a -> a :: acc) ~init:[])
diff --git a/src/dune_stats/dune_stats.ml b/src/dune_stats/dune_stats.ml
index 1234567..abcdefg 100644
--- a/src/dune_stats/dune_stats.ml
+++ b/src/dune_stats/dune_stats.ml
@@ -144,7 +144,7 @@ let global () = !global
 let create ~extended_build_job_info dst =
   let print =
     match dst with
-    | Out out -> Stdlib.output_string out
+    | Out out -> fun s -> Stdlib.output_string out s
     | Custom c -> c.write
   in
   let close =
diff --git a/src/csexp_rpc/csexp_rpc.ml b/src/csexp_rpc/csexp_rpc.ml
index 0a5d308c1..1c1485d9c 100644
--- a/src/csexp_rpc/csexp_rpc.ml
+++ b/src/csexp_rpc/csexp_rpc.ml
@@ -236,10 +236,10 @@ module Session = struct

   external send : Unix.file_descr -> Bytes.t -> int -> int -> int = "dune_send"

-  let write =
+  let write fd bytes pos len =
     match Platform.OS.value with
-    | Linux -> send
-    | _ -> Unix.single_write
+    | Linux -> send fd bytes pos len
+    | _ -> Unix.single_write fd bytes pos len
   ;;

   let rec csexp_write_loop fd out_buf token =
